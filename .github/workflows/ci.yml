name: CI

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Generate cache key
        id: cache-key
        run: echo "key=${{ runner.os }}-node-modules-${{ hashFiles('pnpm-lock.yaml') }}" >> $GITHUB_OUTPUT

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: Type check
        run: pnpm run typecheck

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: Lint
        run: pnpm run lint

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [setup, typecheck]
    outputs:
      build-cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: Generate build cache key
        id: cache-key
        run: echo "key=${{ runner.os }}-build-${{ needs.setup.outputs.cache-key }}" >> $GITHUB_OUTPUT

      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            dist
            .vite
          key: ${{ steps.cache-key.outputs.key }}

      - name: Build application
        run: pnpm run build

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: Unit tests
        run: pnpm run test:unit

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: Integration tests
        run: pnpm run test:integration

  component-tests:
    name: Component Tests
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: Component tests
        run: pnpm run test:component

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [setup, build]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: Restore build artifacts
        uses: actions/cache@v4
        with:
          path: |
            dist
            .vite
          key: ${{ needs.build.outputs.build-cache-key }}

      - name: Get Playwright cache
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps
        if: steps.playwright-cache.outputs.cache-hit != 'true'

      - name: E2E tests
        run: pnpm run test:e2e

      - name: Store Playwright cache
        uses: actions/cache@v4
        if: always() && steps.playwright-cache.outputs.cache-hit != 'true'
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('pnpm-lock.yaml') }}

      - name: Upload E2E test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: playwright-report/
          retention-days: 14

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: Security audit
        run: pnpm audit --audit-level=high

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: Generate coverage report
        run: pnpm run test:coverage

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 14

  # Deploy to staging environment first
  deploy-staging:
    name: Deploy to Staging
    needs: [setup, build, lint, unit-tests, integration-tests, component-tests, e2e-tests, security, coverage]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages-staging
      url: ${{ steps.deployment.outputs.page_url }}
    outputs:
      staging-url: ${{ steps.deployment.outputs.page_url }}
      deployment-id: ${{ steps.deployment.outputs.deployment_id }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: Restore build artifacts
        uses: actions/cache@v4
        with:
          path: |
            dist
            .vite
          key: ${{ needs.build.outputs.build-cache-key }}

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

      - name: Deploy to GitHub Pages (Staging)
        id: deployment
        uses: actions/deploy-pages@v4

  # Run E2E tests against staging environment
  e2e-tests-staging:
    name: E2E Tests on Staging
    needs: deploy-staging
    runs-on: ubuntu-latest
    if: false # Temporarily disabled due to environment issues
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-node_modules-

      - name: Get Playwright cache
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps
        if: steps.playwright-cache.outputs.cache-hit != 'true'

      - name: E2E tests against staging
        env:
          BASE_URL: ${{ needs.deploy-staging.outputs.staging-url }}
        run: |
          echo "Testing staging environment: $BASE_URL"
          pnpm exec playwright test --config playwright.staging.config.ts

      - name: Store Playwright cache
        uses: actions/cache@v4
        if: always() && steps.playwright-cache.outputs.cache-hit != 'true'
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('pnpm-lock.yaml') }}

      - name: Upload staging test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-staging-results
          path: playwright-report/
          retention-days: 14

  # Promote to production or rollback
  promote-production:
    name: Promote to Production
    needs: [deploy-staging, e2e-tests-staging]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get previous production deployment
        id: previous-deployment
        run: |
          echo "Getting previous production deployment..."
          PREVIOUS_DEPLOYMENT=$(gh api repos/:owner/:repo/pages/deployments --jq '.[0]' 2>/dev/null || echo '{}')
          echo "previous-deployment=$PREVIOUS_DEPLOYMENT" >> $GITHUB_OUTPUT

          # Extract previous deployment info for potential rollback
          if [ "$PREVIOUS_DEPLOYMENT" != "{}" ]; then
            PREV_DEPLOY_ID=$(echo "$PREVIOUS_DEPLOYMENT" | jq -r '.id')
            PREV_STATUS_URL=$(echo "$PREVIOUS_DEPLOYMENT" | jq -r '.status_url')
            echo "previous-deployment-id=$PREV_DEPLOY_ID" >> $GITHUB_OUTPUT
            echo "previous-status-url=$PREV_STATUS_URL" >> $GITHUB_OUTPUT
            echo "Found previous production deployment: $PREV_DEPLOY_ID"
          else
            echo "No previous production deployment found"
          fi

      - name: Download staging test results
        run: |
          echo "Downloading staging E2E test results..."
          gh run download ${{ needs.e2e-tests-staging.result }} --name e2e-staging-results || echo "No test results found"

      - name: Analyze staging test results
        id: test-analysis
        run: |
          echo "Analyzing staging E2E test results..."

          # Check if test results artifact exists
          if [ -f "playwright-report/results.json" ]; then
            # Parse test results from JSON report
            TOTAL_TESTS=$(jq '.specs | length' playwright-report/results.json || echo "0")
            PASSED_TESTS=$(jq '.specs | map(select(.ok == true)) | length' playwright-report/results.json || echo "0")
            FAILED_TESTS=$(jq '.specs | map(select(.ok == false)) | length' playwright-report/results.json || echo "0")

            echo "Total tests: $TOTAL_TESTS"
            echo "Passed tests: $PASSED_TESTS"
            echo "Failed tests: $FAILED_TESTS"

            # Determine action based on test results
            if [ "$FAILED_TESTS" -eq 0 ] && [ "$TOTAL_TESTS" -gt 0 ]; then
              echo "All staging tests passed, proceeding with promotion"
              echo "action=promote" >> $GITHUB_OUTPUT
              echo "test-status=all-passed" >> $GITHUB_OUTPUT
            elif [ "$TOTAL_TESTS" -eq 0 ]; then
              echo "No tests found, failing safe - rollback"
              echo "action=rollback" >> $GITHUB_OUTPUT
              echo "test-status=no-tests" >> $GITHUB_OUTPUT
            else
              echo "Some staging tests failed, initiating rollback"
              echo "action=rollback" >> $GITHUB_OUTPUT
              echo "test-status=tests-failed" >> $GITHUB_OUTPUT
              echo "failed-count=$FAILED_TESTS" >> $GITHUB_OUTPUT
            fi
          else
            echo "No test results file found, assuming tests failed - rollback"
            echo "action=rollback" >> $GITHUB_OUTPUT
            echo "test-status=no-results" >> $GITHUB_OUTPUT
          fi

      - name: Rollback to previous version
        if: steps.test-analysis.outputs.action == 'rollback'
        run: |
          echo "ROLLBACK INITIATED"
          echo "Reason: ${{ steps.test-analysis.outputs.test-status }}"
          if [ "${{ steps.test-analysis.outputs.failed-count }}" != "" ]; then
            echo "Failed tests count: ${{ steps.test-analysis.outputs.failed-count }}"
          fi

          if [ "${{ steps.previous-deployment.outputs.previous-deployment-id }}" != "" ] && [ "${{ steps.previous-deployment.outputs.previous-deployment-id }}" != "null" ]; then
            echo "Rolling back to previous production deployment: ${{ steps.previous-deployment.outputs.previous-deployment-id }}"

            # Get current pages deployment info
            CURRENT_DEPLOY=$(gh api repos/:owner/:repo/pages --jq '.deployment' 2>/dev/null || echo '{}')

            if [ "$CURRENT_DEPLOY" != "{}" ]; then
              CURRENT_DEPLOY_ID=$(echo "$CURRENT_DEPLOY" | jq -r '.id')
              echo "Current deployment ID: $CURRENT_DEPLOY_ID"

              # Create a rollback commit message
              echo "::warning::Rolling back deployment due to staging test failures"

              # For GitHub Pages, we need to redeploy the previous artifact
              # This is a simplified rollback - in practice you might need to restore from backup
              echo "Rollback initiated - staging deployment will not be promoted to production"
              echo "Previous production version remains active"
            else
              echo "No current deployment found, nothing to rollback"
            fi
          else
            echo "::error::No previous production deployment found for rollback"
            echo "System will remain in failed state"
            exit 1
          fi

      - name: Promote staging to production
        if: steps.test-analysis.outputs.action == 'promote'
        run: |
          echo "PROMOTION APPROVED"
          echo "All staging tests passed successfully"

          # The staging deployment is already on GitHub Pages at the staging URL
          # Since GitHub Pages only has one environment, the staging deployment
          # is now effectively the production deployment
          echo "Staging deployment promoted to production successfully"
          echo "Production URL: ${{ needs.deploy-staging.outputs.staging-url }}"

          # Log promotion details
          echo "Promotion completed at $(date -u +"%Y-%m-%dT%H:%M:%SZ")"

  # Create release only if core quality checks passed (staging tests disabled)
  release:
    name: Release
    needs: [setup, build, lint, unit-tests, integration-tests, component-tests, e2e-tests, security, coverage]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: Restore build artifacts
        uses: actions/cache@v4
        with:
          path: |
            dist
            .vite
          key: ${{ needs.build.outputs.build-cache-key }}

      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npx semantic-release